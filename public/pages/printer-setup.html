<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>FoodBao - Printer Setup</title>
    
    <!-- Early session check script - Must be first script loaded -->
    <script>
        // Enhanced session verification - inline for fastest possible execution
        (function () {
            try {
                // Check session storage first (higher priority), then localStorage
                const sessionKey = sessionStorage.getItem('session_key') || localStorage.getItem('session_key');
                const authToken = sessionStorage.getItem('auth_token') || localStorage.getItem('auth_token');
                const sessionTimestamp = sessionStorage.getItem('session_timestamp') || localStorage.getItem('session_timestamp');
                const currentTime = new Date().getTime();

                // Prevent back navigation after logout by replacing history state
                history.replaceState(null, document.title, location.href);

                // Force reload on back button navigation to ensure fresh session check
                window.addEventListener('pageshow', function (event) {
                    if (event.persisted) {
                        // This catches bfcache navigation in all browsers
                        window.location.reload();
                    }
                });

                // Comprehensive session validation logic
                if (!sessionKey || !authToken ||
                    !sessionTimestamp ||
                    (currentTime - parseInt(sessionTimestamp)) > (24 * 60 * 60 * 1000)) { // 24 hour max session
                    // Hide content immediately to prevent UI flashing
                    document.documentElement.style.display = 'none';
                    // Redirect with cache-busting parameter
                    const redirectUrl = '/login.html?expired=true&nocache=' + new Date().getTime();
                    window.location.replace(redirectUrl);
                    throw new Error('Session invalid or expired');
                }

                // Advanced visibility change detection
                document.addEventListener('visibilitychange', function () {
                    if (document.visibilityState === 'visible') {
                        performFullSessionCheck();
                    }
                });

                function performFullSessionCheck() {
                    const currentSessionKey = sessionStorage.getItem('session_key') || localStorage.getItem('session_key');
                    const currentAuthToken = sessionStorage.getItem('auth_token') || localStorage.getItem('auth_token');
                    const currentTimestamp = sessionStorage.getItem('session_timestamp') || localStorage.getItem('session_timestamp');
                    const now = new Date().getTime();

                    if (!currentSessionKey || !currentAuthToken ||
                        !currentTimestamp ||
                        (now - parseInt(currentTimestamp)) > (24 * 60 * 60 * 1000)) {
                        document.documentElement.style.display = 'none';
                        sessionStorage.clear();
                        localStorage.removeItem('session_key');
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('session_timestamp');
                        const redirectUrl = '/login.html?expired=true&nocache=' + now;
                        window.location.replace(redirectUrl);
                    }
                }

                // Set initial check point
                sessionStorage.setItem('last_activity', currentTime.toString());
                if (localStorage.getItem('session_key')) {
                    localStorage.setItem('session_timestamp', currentTime.toString());
                }
            } catch (e) {
                // Fail safe: redirect to login on any error
                console.error('Session verification failed:', e);
                document.documentElement.style.display = 'none';
                sessionStorage.clear();
                localStorage.removeItem('session_key');
                localStorage.removeItem('auth_token');
                localStorage.removeItem('session_timestamp');
                window.location.replace('/login.html?error=true&nocache=' + new Date().getTime());
            }
        })();
    </script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="../css/materialize.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/compact-ui.css">
    
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --primary-light: #a4d0f5;
            --accent-color: #2ecc71;
            --secondary-color: #f39c12;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-on-primary: white;
            --text-dark: #333;
            --bg-light: #f5f9ff;
            --transition-speed: 0.3s;
            --header-height: 32px;
        }
          body {
            background-color: var(--bg-light);
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            font-size: 12px;
        }        .setup-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 5px;
        }
          .setup-section {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 10px;
            position: relative;
        }
          .setup-section-header {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-dark);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .setup-section-header i {
            font-size: 18px;
            margin-right: 8px;
        }
          .chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
          .custom-chip {
            background-color: #f0f7ff;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .custom-chip.active {
            background-color: var(--primary-color);
            color: white;
        }
          .printer-item {
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            background-color: #fafafa;
            border-left: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .printer-info {
            display: flex;
            flex-direction: column;
        }
        
        .printer-name {
            font-weight: 500;
            margin-bottom: 2px;
            font-size: 11px;
        }
          .printer-type {
            font-size: 10px;
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background-color: var(--primary-color);
            color: white;
        }
          .btn-icon i {
            font-size: 14px;
        }
        
        /* Add compact chip styles */
        .chip.small {
            height: 18px;
            line-height: 18px;
            padding: 0 8px;
            font-size: 9px;
            margin: 2px;
        }
        
        .modal-small {
            max-width: 400px;
            border-radius: 4px;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .tabs-container {
            margin: 15px 0;
        }
        
        .preview-section {
            padding: 15px;
            background-color: #fafafa;
            border-radius: 8px;
        }
          .receipt-preview {
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-family: 'Courier New', monospace;
            font-size: 10px;
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
            line-height: 1.2;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 6px;
        }
        
        .receipt-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 1px;
        }
          .receipt-items {
            margin: 5px 0;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .receipt-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-top: 4px;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 5px;
            font-size: 9px;
        }
        
        .receipt-barcode {
            text-align: center;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
            font-size: 9px;
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .status-message.info {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        
        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
          .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Optimize for small screens */
        @media screen and (max-width: 600px) {
            .setup-container {
                grid-template-columns: 1fr;
                gap: 3px;
                padding: 0 2px;
            }
            
            .setup-section {
                padding: 6px;
                border-radius: 3px;
                margin-bottom: 3px;
            }
            
            .receipt-preview {
                max-width: 220px;            }
            
            .btn-icon {
                width: 22px;
                height: 22px;
            }
            
            .btn-icon i {
                font-size: 13px;
            }
            
            body {
                font-size: 11px;
            }
            
            /* Further minimize space */
            .row {
                margin-bottom: 3px;
            }
            
            .col {
                padding: 0 3px;
            }
            
            button, .btn, .btn-custom {
                height: 26px;
                line-height: 26px;
                padding: 0 8px;
            }
            
            label {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="app-header" style="height: 32px;"></div>
      <div class="container" style="width: 100%; max-width: 100%; padding: 0; margin: 0;">
        <div class="setup-container">
            <div id="statusMessage" class="status-message info" style="display: none; font-size: 11px; padding: 5px; margin: 0 0 5px 0;"></div>
            
            <div class="setup-section">                <div class="setup-section-header">
                    <div>
                        <i class="material-icons" style="font-size: 16px;">print</i>
                        <span style="font-size: 13px;">Printers</span>
                    </div>
                    <button class="btn-floating btn-small waves-effect waves-light" id="addPrinterBtn" style="width: 28px; height: 28px; line-height: 28px;">
                        <i class="material-icons" style="font-size: 16px; line-height: 28px;">add</i>
                    </button>
                </div>
                  <div class="chip-container" id="departmentFilter" style="margin: 5px 0;">
                    <div class="custom-chip active" data-department="ALL">All</div>
                    <div class="custom-chip" data-department="KITCHEN">Kitchen</div>
                    <div class="custom-chip" data-department="CASHIER">Cashier</div>
                    <div class="custom-chip" data-department="FOOD_ORDER">Order</div>
                    <div class="custom-chip" data-department="SERVING">Serving</div>
                </div>
                
                <div id="printerList" class="printer-list">
                    <!-- Printer items will be added here dynamically -->
                </div>
                  <div class="center-align" style="margin-top: 5px;">
                    <label style="font-size: 12px;">
                        <input type="checkbox" id="autoPrint" class="filled-in" checked />
                        <span>Auto-print orders</span>
                    </label>
                </div>
            </div>
            
            <div class="setup-section">                <div class="setup-section-header">
                    <div>
                        <i class="material-icons" style="font-size: 16px;">receipt</i>
                        <span style="font-size: 13px;">Receipt</span>
                    </div>
                    <button class="btn-flat waves-effect" id="testPrintBtn" style="padding: 0 5px; height: 28px; line-height: 28px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 4px;">print</i>
                        <span style="font-size: 12px;">Test</span>
                    </button>
                </div>
                  <div class="preview-section" style="padding: 0;">
                    <div class="receipt-preview" style="font-size: 10px; line-height: 1.2;">                        <div class="receipt-header" style="line-height: 1.1; margin-bottom: 3px;">
                            <div class="receipt-title" style="font-size: 11px; margin-bottom: 1px;">FOODBAO</div>
                            <div style="font-size: 9px;">123 Main Street</div>
                            <div style="font-size: 9px;">City, State 12345</div>
                            <div style="font-size: 9px;">Tel: (123) 456-7890</div>
                            <div style="font-size: 9px;">Order #: 10001</div>
                            <div style="font-size: 9px;">2025-05-13 10:30 AM</div>
                        </div>
                          <div class="receipt-items" style="margin: 3px 0; padding: 3px 0;">
                            <div class="receipt-item" style="font-size: 9px; margin-bottom: 1px;">
                                <span>1x Chicken Rice</span>
                                <span>RM 12.50</span>
                            </div>
                            <div class="receipt-item" style="font-size: 9px; margin-bottom: 1px;">
                                <span>1x Iced Tea</span>
                                <span>RM 3.00</span>
                            </div>
                            <div class="receipt-item" style="font-size: 9px; margin-bottom: 1px;">
                                <span>1x Fish Curry</span>
                                <span>RM 14.90</span>
                            </div>
                        </div>
                        
                        <div class="receipt-total" style="font-size: 9px; margin-top: 3px;">
                            <span>TOTAL:</span>
                            <span>RM 30.40</span>
                        </div>
                          <div class="receipt-footer" style="margin-top: 3px; font-size: 8px; line-height: 1;">
                            <p style="margin: 1px 0;">Thank you!</p>
                            <p style="margin: 1px 0;">Please come again</p>
                        </div>
                        
                        <div class="receipt-barcode" style="margin-top: 3px; font-size: 8px;">
                            *FB10001*
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
      <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal modal-small">
        <div class="modal-header" style="padding: 5px 10px;">
            <h5 style="font-size: 14px; margin: 0;">Add Printer</h5>
            <button class="btn-flat modal-close waves-effect" style="padding: 0; min-width: 24px; height: 24px;">
                <i class="material-icons" style="font-size: 16px;">close</i>
            </button>
        </div>
        <div class="modal-content" style="padding: 10px;">            <div class="input-field" style="margin: 5px 0;">
                <input id="printerName" type="text" class="validate" required style="margin: 0; height: 2rem; font-size: 12px;">
                <label for="printerName" style="font-size: 12px;">Printer Name</label>
            </div>
            
            <div class="input-field" style="margin: 5px 0;">
                <select id="printerDepartment" style="height: 2rem; font-size: 12px;">
                    <option value="" disabled selected>Department</option>
                    <option value="KITCHEN">Kitchen</option>
                    <option value="CASHIER">Cashier</option>
                    <option value="FOOD_ORDER">Food Order</option>
                    <option value="SERVING">Serving</option>
                </select>
                <label>Department</label>
            </div>
              <div class="tabs-container">
                <ul class="tabs" style="height: 32px;">
                    <li class="tab col s4" style="height: 32px; line-height: 32px;"><a href="#bluetoothTab" class="active" style="font-size: 11px;">Bluetooth</a></li>
                    <li class="tab col s4" style="height: 32px; line-height: 32px;"><a href="#networkTab" style="font-size: 11px;">Network</a></li>
                    <li class="tab col s4" style="height: 32px; line-height: 32px;"><a href="#usbTab" style="font-size: 11px;">USB</a></li>
                </ul>
                  <div id="bluetoothTab" class="col s12" style="padding: 10px 0;">
                    <button id="scanBluetoothBtn" class="btn waves-effect waves-light" style="height: 30px; line-height: 30px; font-size: 11px; padding: 0 10px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 5px;">bluetooth_searching</i>
                        Scan
                    </button>
                    
                    <div id="bluetoothDevices" class="collection" style="margin-top: 10px; font-size: 11px;">
                        <!-- Bluetooth devices will be listed here -->
                    </div>
                </div>
                  <div id="networkTab" class="col s12" style="padding: 10px 0;">
                    <div class="input-field" style="margin: 5px 0;">
                        <input id="networkIp" type="text" class="validate" style="height: 2rem; font-size: 12px; margin: 0;">
                        <label for="networkIp" style="font-size: 12px;">IP Address</label>
                    </div>
                    
                    <div class="input-field" style="margin: 5px 0;">
                        <input id="networkPort" type="number" class="validate" value="9100" style="height: 2rem; font-size: 12px; margin: 0;">
                        <label for="networkPort" style="font-size: 12px;">Port</label>
                    </div>
                    
                    <button id="testNetworkBtn" class="btn waves-effect waves-light" style="height: 30px; line-height: 30px; font-size: 11px; padding: 0 10px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 5px;">network_check</i>
                        Test
                    </button>
                </div>
                  <div id="usbTab" class="col s12" style="padding: 10px 0;">
                    <button id="scanUsbBtn" class="btn waves-effect waves-light" style="height: 30px; line-height: 30px; font-size: 11px; padding: 0 10px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 5px;">usb</i>
                        Scan USB
                    </button>
                    
                    <div id="usbDevices" class="collection" style="margin-top: 10px; font-size: 11px;">
                        <!-- USB devices will be listed here -->
                    </div>
                </div>
            </div>
        </div>        <div class="modal-footer" style="padding: 0 10px 10px;">
            <button class="modal-close waves-effect btn-flat" style="height: 30px; line-height: 30px; font-size: 11px; padding: 0 10px;">Cancel</button>
            <button id="savePrinterBtn" class="waves-effect waves-light btn" style="height: 30px; line-height: 30px; font-size: 11px; padding: 0 10px;">
                <i class="material-icons left" style="font-size: 14px; margin-right: 5px;">save</i>
                Save
            </button>
        </div>
    </div>
      <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner" style="width: 24px; height: 24px;"></div>
    </div>
            padding-top: 32px; /* Adjusted from var(--header-height) */
            font-size: 14px;
        }
          .setup-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
        }
          /* Compact design section */
        .setup-section {
            background: white;
            padding: 0.25rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .setup-section-header {
            padding: 3px 0;
            margin-bottom: 3px;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: var(--primary-dark);
            border-bottom: 1px solid #f0f0f0;
        }
        
        .setup-section-header i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .setup-section-content {
            padding: 5px 0;
        }
        
        .btn-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
            height: 32px;
            line-height: 20px;
            box-shadow: none;
        }
        
        .btn-custom:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-custom.btn-small {
            padding: 4px 8px;
            font-size: 12px;
            height: 24px;
            line-height: 16px;
        }
        
        /* Printer list items */
        .printer-item {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            position: relative;
            border-left: 3px solid var(--primary-color);
        }
        
        .printer-item.kitchen {
            border-left-color: var(--danger-color);
        }
        
        .printer-item.bar {
            border-left-color: var(--warning-color);
        }
        
        .printer-item .printer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .printer-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-dark);
        }
        
        .printer-actions {
            display: flex;
            gap: 5px;
        }
        
        .printer-details {
            font-size: 12px;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .printer-detail {
            display: flex;
            align-items: center;
        }
        
        .printer-detail i {
            font-size: 14px;
            margin-right: 4px;
            opacity: 0.7;
        }
          .department-chip {
            display: inline-block;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .department-chip.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Tabs in Modal */
        .tabs .tab a {
            color: var(--primary-color);
            font-size: 13px;
            padding: 0 10px;
            height: 42px;
            line-height: 42px;
        }
        
        .tabs .tab a:hover, .tabs .tab a.active {
            color: var(--primary-dark);
        }
        
        .tabs .indicator {
            background-color: var(--primary-color);
        }
        
        /* Form elements */
        .input-field {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .input-field label {
            font-size: 13px;
        }
        
        .input-field input, .input-field select {
            height: 36px;
            font-size: 13px;
        }
          /* Status message */
        .status-message {
            padding: 4px 8px;
            border-radius: 3px;
            margin-bottom: 5px;
            font-size: 11px;
        }
        
        .status-message.info {
            background-color: #e3f2fd;
            color: #0277bd;
        }
        
        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .loading-container {
            text-align: center;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Compact form inputs */
        input[type="text"], 
        input[type="number"], 
        select {
            height: 32px !important;
            font-size: 13px !important;
        }
        
        .modal {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .modal-content {
            padding: 15px !important;
        }
        
        .modal-footer {
            padding: 10px 15px !important;
        }
    </style>
</head>
<body style="padding: 0; margin: 0; overflow-x: hidden;">
    <app-header></app-header>
    <div class="setup-container" style="margin-top: 0; padding-top: 0; width: 100%;"><!-- Status Message -->
        <div id="statusMessage" class="status-message info" style="display: none; font-size: 11px; padding: 4px 8px; margin: 0 0 4px 0; border-radius: 3px;"></div>
          <!-- Printer Management Section -->
        <div class="setup-section">
            <div class="setup-section-header" style="padding-bottom: 5px; margin-bottom: 5px;">
                <i class="material-icons" style="font-size: 16px;">print</i>
                <div style="display: flex; align-items: center;">
                    <button id="addPrinterBtn" class="btn-custom" style="margin-left: auto; height: 28px; line-height: 28px; padding: 0 10px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 4px;">add</i>
                        <span style="font-size: 12px;">Add Printer</span>
                    </button>
                </div>
            </div>
            
            <div class="setup-section-content">
                <div class="row" style="margin: 0 0 5px 0;">
                    
                    <div class="col s12 m6 right-align">
                        <div class="switch" style="display: inline-flex; align-items: center;">
                            <label style="font-size: 13px;">
                                Auto Print:
                                <input type="checkbox" id="autoPrint">
                                <span class="lever"></span>
                            </label>
                        </div>
                    </div>
                </div>
                  <!-- Department Filter -->
                <div id="departmentFilter" class="department-filter" style="margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                    <div class="department-chip active" data-department="all" style="font-size: 11px; padding: 2px 8px; background: #e0e0e0; border-radius: 12px; cursor: pointer;">All</div>
                    <div class="department-chip" data-department="kitchen" style="font-size: 11px; padding: 2px 8px; background: #f0f0f0; border-radius: 12px; cursor: pointer;">Kitchen</div>
                    <div class="department-chip" data-department="bar" style="font-size: 11px; padding: 2px 8px; background: #f0f0f0; border-radius: 12px; cursor: pointer;">Bar</div>
                    <div class="department-chip" data-department="front" style="font-size: 11px; padding: 2px 8px; background: #f0f0f0; border-radius: 12px; cursor: pointer;">Front</div>
                </div>
                
                <!-- Printer List -->
                <div id="printerList" class="printer-list"></div>
            </div>
        </div>
          <!-- Receipt Preview Section -->
        <div class="setup-section">
            <div class="setup-section-header" style="padding-bottom: 5px; margin-bottom: 5px;">
                <i class="material-icons" style="font-size: 16px;">receipt</i>
                <div style="display: flex; align-items: center;">
                    <button class="btn-custom btn-small" id="testPrintBtn" style="margin-left: auto; height: 28px; line-height: 28px; padding: 0 10px;">
                        <i class="material-icons left" style="font-size: 14px; margin-right: 4px;">print</i>
                        <span style="font-size: 12px;">Test Print</span>
                    </button>
                </div>
            </div>
            
            <div class="setup-section-content" style="padding-top: 0;">
                <div class="receipt-preview" style="font-family: monospace; font-size: 11px; line-height: 1.2; white-space: pre-wrap; background: #f7f7f7; padding: 8px; border-radius: 4px; margin-top: 0;">
                    FOODBAO RECEIPT
                    -----------------------
                    Date: <span id="receiptDate">May 13, 2025 10:00:00</span>
                    Order #: FB123456
                    
                    ITEMS:
                    1 x Beef Noodles      $12.50
                    2 x Spring Rolls      $7.00
                    1 x Bubble Tea        $5.50
                    -----------------------
                    TOTAL:               $25.00                    
                    Thank you for your order!
                </div>
            </div>
        </div>
    </div>
      <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal" style="max-width: 400px; border-radius: 4px;">
        <div class="modal-content" style="padding: 10px;">
            <h5 style="margin: 0 0 8px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
                Add Printer
                <a class="modal-close" style="cursor: pointer; color: #999;">
                    <i class="material-icons" style="font-size: 16px;">close</i>
                </a>
            </h5>
            
            <div class="row" style="margin-bottom: 0;">
                <form id="printerForm" class="col s12" style="padding: 0;">
                    <input type="hidden" id="printerId">
                    
                    <div class="row" style="margin-bottom: 3px;">
                        <div class="input-field col s12 m6" style="margin: 0 0 5px 0;">
                            <input id="printerName" type="text" class="validate" style="height: 2rem; margin: 0; font-size: 12px;">
                            <label for="printerName" style="font-size: 12px;">Printer Name</label>
                        </div>
                        
                        <div class="input-field col s12 m6" style="margin: 0 0 5px 0;">
                            <select id="printerDepartment" style="height: 2rem; font-size: 12px;">
                                <option value="kitchen">Kitchen</option>
                                <option value="bar">Bar</option>
                                <option value="front">Front</option>
                            </select>
                            <label style="font-size: 12px;">Department</label>                    </div>
                    
                    <div class="row" style="margin-bottom: 3px;">
                        <div class="col s12">
                            <ul class="tabs" style="height: 30px;">
                                <li class="tab col s4" style="height: 30px; line-height: 30px;"><a href="#networkTab" style="font-size: 11px;">Network</a></li>
                                <li class="tab col s4" style="height: 30px; line-height: 30px;"><a href="#bluetoothTab" id="bluetoothTabLink" style="font-size: 11px;">Bluetooth</a></li>
                                <li class="tab col s4" style="height: 30px; line-height: 30px;"><a href="#usbTab" id="usbTabLink" style="font-size: 11px;">USB</a></li>
                            </ul>
                        </div>
                        
                        <!-- Network Tab -->
                        <div id="networkTab" class="col s12" style="padding-top: 5px;">                            <div class="row" style="margin-bottom: 3px;">
                                <div class="input-field col s12 m8" style="margin: 0 0 3px 0;">
                                    <input id="networkIp" type="text" class="validate" style="height: 2rem; margin: 0; font-size: 12px;">
                                    <label for="networkIp" style="font-size: 12px;">IP Address</label>
                                </div>
                                
                                <div class="input-field col s12 m4" style="margin: 0 0 3px 0;">
                                    <input id="networkPort" type="number" class="validate" value="9100" style="height: 2rem; margin: 0; font-size: 12px;">
                                    <label for="networkPort" style="font-size: 12px;">Port</label>
                                </div>
                            </div>
                            
                            <div class="right-align">
                                <button type="button" id="testNetworkBtn" class="btn-custom btn-small" style="height: 24px; line-height: 24px; padding: 0 8px; font-size: 11px;">
                                    <i class="material-icons left" style="font-size: 12px; margin-right: 3px;">wifi</i>
                                    Test
                                </button>
                            </div>
                        </div>
                        
                        <!-- Bluetooth Tab -->
                        <div id="bluetoothTab" class="col s12" style="padding-top: 5px;">                            <p class="grey-text text-darken-1" style="font-size: 11px; margin: 0 0 3px 0;">
                                Bluetooth printers must be powered on and in pairing mode.
                            </p>
                            
                            <div class="input-field" style="margin: 0 0 3px 0;">
                                <select id="bluetoothDevices" style="height: 2rem; font-size: 12px;">
                                    <option value="" disabled selected>Select a device</option>
                                </select>
                                <label style="font-size: 12px;">Bluetooth Devices</label>
                            </div>
                            
                            <div class="right-align">
                                <button id="scanBluetoothBtn" class="btn-custom" style="height: 24px; line-height: 24px; padding: 0 8px; font-size: 11px;">
                                    <i class="material-icons left" style="font-size: 12px; margin-right: 3px;">bluetooth_searching</i>
                                    Scan
                                </button>
                            </div>
                        </div>
                        
                        <!-- USB Tab -->
                        <div id="usbTab" class="col s12" style="padding-top: 5px;">                            <p class="grey-text text-darken-1" style="font-size: 11px; margin: 0 0 3px 0;">
                                USB printers must be connected and powered on.
                            </p>
                            
                            <div class="input-field" style="margin: 0 0 3px 0;">
                                <select id="usbDevices" style="height: 2rem; font-size: 12px;">
                                    <option value="" disabled selected>Select a device</option>
                                </select>
                                <label style="font-size: 12px;">USB Devices</label>
                            </div>
                            
                            <div class="right-align">
                                <button id="scanUsbBtn" class="btn-custom" style="height: 24px; line-height: 24px; padding: 0 8px; font-size: 11px;">
                                    <i class="material-icons left" style="font-size: 12px; margin-right: 3px;">usb</i>
                                    Scan
                                </button>
                            </div>
                        </div>
                    </div>
                      <div class="row" style="margin-bottom: 0;">
                        <div class="input-field col s12" style="margin: 0;">
                            <p style="margin: 3px 0 0 0;">
                                <label style="font-size: 11px;">
                                    <input type="checkbox" id="isDefaultPrinter" />
                                    <span style="padding-left: 20px;">Default Printer</span>
                                </label>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="modal-footer" style="padding: 5px 10px; height: auto;">
            <button class="modal-close waves-effect btn-flat" style="margin-right: 8px; font-size: 11px; height: 24px; line-height: 24px; padding: 0 8px;">Cancel</button>
            <button id="savePrinterBtn" class="waves-effect waves-light btn-custom" style="font-size: 11px; height: 24px; line-height: 24px; padding: 0 8px;">
                <i class="material-icons left" style="font-size: 12px; margin-right: 3px;">save</i>
                Save
            </button>
        </div>
    </div>
      <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container" style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
            <div class="loading-spinner" style="width: 20px; height: 20px;"></div>
            <div class="loading-message" style="font-size: 11px;">Loading...</div>
        </div>
    </div><!-- Include header.js for app header -->
    <script src="../js/components/header.js"></script>
    
    <!-- Include API handler -->
    <script src="../js/api-handler.js"></script>
    
    <!-- Materialize JS -->
    <script src="../js/materialize.min.js"></script>
    
    <!-- Load Printer Service Script -->
    <script src="../js/printer-service.js"></script>
    
    <!-- Printer Setup Scripts -->
    <script>
        // Declare these variables at global scope for the script
        let statusMessage, loadingOverlay, autoPrintCheckbox, printerList, departmentFilter;
        let addPrinterBtn, addPrinterModal, savePrinterBtn, scanBluetoothBtn, scanUsbBtn, testNetworkBtn, testPrintBtn;
        let modalInstance, tabs, selects;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI elements first
            initializeUIElements();
            
            // Check authentication status before page renders
            (function checkAuth() {
                try {
                    const token = localStorage.getItem('auth_token');
                    const username = localStorage.getItem('username');
                    
                    if (!token || !username) {
                        console.log('Not authenticated, redirecting to login page');
                        window.location.href = '../login.html';
                        return;
                    }
                    
                    // Load user profile data
                    fetchProfileData();
                    
                    // Initialize printer service
                    initPrinterManager();
                } catch (error) {
                    console.error('Authentication check failed:', error);
                    showStatus('Authentication error: ' + error.message, 'error');
                }
            })();
            
            // Initialize UI elements function
            function initializeUIElements() {
                try {
                    // Elements
                    statusMessage = document.getElementById('statusMessage');
                    loadingOverlay = document.getElementById('loadingOverlay');
                    autoPrintCheckbox = document.getElementById('autoPrint');
                    printerList = document.getElementById('printerList');
                    departmentFilter = document.getElementById('departmentFilter');
                    testPrintBtn = document.getElementById('testPrintBtn');
                    
                    // Modal elements
                    addPrinterBtn = document.getElementById('addPrinterBtn');
                    addPrinterModal = document.getElementById('addPrinterModal');
                    savePrinterBtn = document.getElementById('savePrinterBtn');
                    scanBluetoothBtn = document.getElementById('scanBluetoothBtn');
                    scanUsbBtn = document.getElementById('scanUsbBtn');
                    testNetworkBtn = document.getElementById('testNetworkBtn');
                    
                    // Update checkbox from stored settings
                    if (autoPrintCheckbox) {
                        autoPrintCheckbox.checked = localStorage.getItem('autoPrint') !== 'false';
                    }
                    
                    // Initialize UI components
                    initializeUIComponents();
                    
                    // Setup event listeners
                    setupEventListeners();
                } catch (error) {
                    console.error('Error initializing UI elements:', error);
                    alert('Error initializing UI: ' + error.message);
                }
            }
            
            // Initialize UI components (Materialize)
            function initializeUIComponents() {
                try {
                    // Initialize Modal
                    if (document.getElementById('addPrinterModal')) {
                        modalInstance = M.Modal.init(document.getElementById('addPrinterModal'), {
                            dismissible: false,
                            opacity: 0.5
                        });
                    }
                    
                    // Initialize Tabs
                    if (document.querySelector('.tabs')) {
                        tabs = M.Tabs.init(document.querySelector('.tabs'), {});
                    }
                    
                    // Initialize Selects
                    if (document.querySelectorAll('select').length > 0) {
                        selects = M.FormSelect.init(document.querySelectorAll('select'), {});
                    }
                } catch (error) {
                    console.error('Error initializing UI components:', error);
                    showStatus('Error initializing UI components: ' + error.message, 'error');
                }
            }
            
            // Setup event listeners for UI elements
            function setupEventListeners() {
                try {
                    // Add printer button
                    if (addPrinterBtn) {
                        addPrinterBtn.addEventListener('click', function() {
                            if (modalInstance) modalInstance.open();
                        });
                    }
                    
                    // Save printer button
                    if (savePrinterBtn) {
                        savePrinterBtn.addEventListener('click', savePrinter);
                    }
                    
                    // Scan buttons
                    if (scanBluetoothBtn) {
                        scanBluetoothBtn.addEventListener('click', scanBluetoothDevices);
                    }
                    
                    if (scanUsbBtn) {
                        scanUsbBtn.addEventListener('click', scanUsbDevices);
                    }
                    
                    if (testNetworkBtn) {
                        testNetworkBtn.addEventListener('click', testNetworkConnection);
                    }
                    
                    // Test print button
                    if (testPrintBtn) {
                        testPrintBtn.addEventListener('click', testPrint);
                    }
                    
                    // Auto print checkbox
                    if (autoPrintCheckbox) {
                        autoPrintCheckbox.addEventListener('change', function() {
                            localStorage.setItem('autoPrint', this.checked);
                        });
                    }
                    
                    // Department filter chips
                    if (departmentFilter) {
                        const chips = departmentFilter.querySelectorAll('.custom-chip');
                        chips.forEach(chip => {
                            chip.addEventListener('click', function() {
                                // Remove active class from all chips
                                chips.forEach(c => c.classList.remove('active'));
                                
                                // Add active class to clicked chip
                                this.classList.add('active');
                                
                                // Filter printers
                                const department = this.dataset.department;
                                filterPrintersByDepartment(department);
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error setting up event listeners:', error);
                    showStatus('Error setting up event listeners: ' + error.message, 'error');
                }
            }
            
            // Check if needed APIs are supported
            function checkApiSupport() {
                try {
                    const supportInfo = {
                        bluetooth: 'bluetooth' in navigator,
                        usb: 'usb' in navigator,
                        network: true // Network printing via API is always available
                    };
                    
                    if (!supportInfo.bluetooth && document.querySelector('#bluetoothTab')) {
                        document.querySelector('#bluetoothTab').innerHTML = 
                            '<p class="red-text">Your browser does not support Bluetooth. Please use Chrome, Edge, or Opera.</p>';
                    }
                    
                    if (!supportInfo.usb && document.querySelector('#usbTab')) {
                        document.querySelector('#usbTab').innerHTML = 
                            '<p class="red-text">Your browser does not support USB devices or you\'re not using the installed PWA.</p>';
                    }
                    
                    return supportInfo;
                } catch (error) {
                    console.error('Error checking API support:', error);
                    return {
                        bluetooth: false,
                        usb: false,
                        network: true
                    };
                }
            }
            
            // Initialize printer manager
            async function initPrinterManager() {
                try {
                    // Show loading overlay
                    showLoading(true);
                    
                    // Check API support
                    const apiSupport = checkApiSupport();
                    console.log('API support:', apiSupport);
                    
                    // Load printers from database
                    await loadPrinters();
                    
                    // Hide loading overlay
                    showLoading(false);
                    
                    // Show success message
                    showStatus('Printer manager initialized successfully', 'success');
                } catch (error) {
                    console.error('Error initializing printer manager:', error);
                    showStatus('Error initializing printer manager: ' + error.message, 'error');
                    showLoading(false);
                }
            }
              // Load printers from database or local storage
            async function loadPrinters() {
                try {
                    // Clear printer list
                    if (printerList) {
                        printerList.innerHTML = '';
                    }
                    
                    // Get printers from printer service
                    let printers = [];
                    try {
                        printers = await window.printerService.getPrinters();
                    } catch (error) {
                        console.log('Using empty printer list due to API error:', error);
                        // Continue with empty array if API fails
                    }
                    
                    if (printers.length === 0) {
                        // Show message if no printers found
                        if (printerList) {
                            printerList.innerHTML = `
                                <div class="center-align" style="padding: 10px; color: #999; font-size: 11px;">
                                    <i class="material-icons small">print_disabled</i>
                                    <p style="margin: 5px 0;">No printers added</p>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Display printers
                    printers.forEach(printer => {
                        addPrinterToList(printer);
                    });
                } catch (error) {
                    console.error('Error loading printers:', error);
                    showStatus('Error loading printers: ' + error.message, 'error');
                }
            }
            
            // Add printer to the UI list
            function addPrinterToList(printer) {
                if (!printerList) return;
                
                const printerItem = document.createElement('div');
                printerItem.className = 'printer-item';
                printerItem.dataset.id = printer.id;
                printerItem.dataset.department = printer.department || 'NONE';
                
                printerItem.innerHTML = `
                    <div class="printer-info">
                        <div class="printer-name">${printer.name}</div>
                        <div class="printer-type">
                            <span class="chip small">${printer.department || 'No Department'}</span>
                            <span class="chip small">${getPrinterTypeLabel(printer.type)}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <div class="btn-icon test-printer-btn" title="Test Printer">
                            <i class="material-icons">play_arrow</i>
                        </div>
                        <div class="btn-icon edit-printer-btn" title="Edit Printer">
                            <i class="material-icons">edit</i>
                        </div>
                        <div class="btn-icon delete-printer-btn" title="Delete Printer">
                            <i class="material-icons">delete</i>
                        </div>
                    </div>
                `;
                
                // Add event listeners for action buttons
                const testBtn = printerItem.querySelector('.test-printer-btn');
                const editBtn = printerItem.querySelector('.edit-printer-btn');
                const deleteBtn = printerItem.querySelector('.delete-printer-btn');
                
                if (testBtn) {
                    testBtn.addEventListener('click', () => testPrinter(printer.id));
                }
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => editPrinter(printer.id));
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deletePrinter(printer.id));
                }
                
                printerList.appendChild(printerItem);
            }
            
            // Get printer type label for display
            function getPrinterTypeLabel(type) {
                switch (type) {
                    case 'BLUETOOTH':
                        return 'Bluetooth';
                    case 'USB':
                        return 'USB';
                    case 'NETWORK':
                        return 'Network';
                    default:
                        return type || 'Unknown';
                }
            }
            
            // Filter printers by department
            function filterPrintersByDepartment(department) {
                if (!printerList) return;
                
                const printerItems = printerList.querySelectorAll('.printer-item');
                
                printerItems.forEach(item => {
                    if (department === 'ALL' || item.dataset.department === department) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show message if no printers in the selected department
                const visiblePrinters = Array.from(printerItems).filter(item => item.style.display !== 'none');
                  if (visiblePrinters.length === 0) {
                    const noResultsMessage = document.createElement('div');
                    noResultsMessage.className = 'center-align no-results-message';
                    noResultsMessage.style.padding = '8px';
                    noResultsMessage.style.color = '#999';
                    noResultsMessage.style.fontSize = '11px';
                    noResultsMessage.innerHTML = `
                        <p style="margin: 0;">No printers in this filter</p>
                    `;
                    
                    // Remove any existing no results message
                    const existingMessage = printerList.querySelector('.no-results-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    
                    printerList.appendChild(noResultsMessage);
                } else {
                    // Remove any existing no results message
                    const existingMessage = printerList.querySelector('.no-results-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }
            }
            
            // Test printer connection
            async function testPrinter(printerId) {
                try {
                    showLoading(true);
                    
                    // Get printer from service
                    const printers = await window.printerService.getPrinters();
                    const printer = printers.find(p => p.id === printerId);
                    
                    if (!printer) {
                        throw new Error('Printer not found');
                    }
                    
                    // Test the printer
                    const result = await window.printerService.testPrinter(printer);
                    
                    showLoading(false);
                    showStatus(result.message || 'Printer test completed', result.success ? 'success' : 'error');
                } catch (error) {
                    console.error('Error testing printer:', error);
                    showStatus('Error testing printer: ' + error.message, 'error');
                    showLoading(false);
                }
            }
            
            // Edit printer settings
            function editPrinter(printerId) {
                // Implementation for editing printer
                console.log('Edit printer:', printerId);
                showStatus('Edit printer functionality not implemented yet', 'info');
            }
            
            // Delete printer
            async function deletePrinter(printerId) {
                try {
                    // Confirm delete
                    if (!confirm('Are you sure you want to delete this printer?')) {
                        return;
                    }
                    
                    showLoading(true);
                    
                    // Delete printer
                    const result = await window.printerService.removePrinter(printerId);
                    
                    if (result.success) {
                        // Reload printers
                        await loadPrinters();
                        showStatus('Printer deleted successfully', 'success');
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                    
                    showLoading(false);
                } catch (error) {
                    console.error('Error deleting printer:', error);
                    showStatus('Error deleting printer: ' + error.message, 'error');
                    showLoading(false);
                }
            }
            
            // Scan for Bluetooth devices
            async function scanBluetoothDevices() {
                try {
                    showLoading(true);
                    
                    const bluetoothList = document.getElementById('bluetoothDevices');
                    if (bluetoothList) {
                        bluetoothList.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';
                    }
                    
                    // Check Bluetooth support
                    if (!('bluetooth' in navigator)) {
                        throw new Error('Bluetooth API not supported in this browser');
                    }
                    
                    // Request device
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [
                            { services: ['1812'] }, // Printer service
                            { namePrefix: 'POS' },  // Common prefix for POS printers
                            { namePrefix: 'Star' }, // Star printers
                            { namePrefix: 'Epson' } // Epson printers
                        ],
                        optionalServices: ['1812', '180f', '180a']
                    });
                    
                    console.log('Bluetooth device selected:', device);
                    
                    // Display device in the list
                    if (bluetoothList) {
                        bluetoothList.innerHTML = `
                            <a href="#!" class="collection-item bluetooth-device" data-id="${device.id}" data-name="${device.name}">
                                <div>${device.name || 'Unknown Device'}</div>
                                <span class="secondary-content green-text">
                                    <i class="material-icons">check</i>
                                </span>
                            </a>
                        `;
                        
                        // Add click event to select device
                        const deviceElement = bluetoothList.querySelector('.bluetooth-device');
                        if (deviceElement) {
                            deviceElement.addEventListener('click', function() {
                                // Select this device
                                const devices = bluetoothList.querySelectorAll('.bluetooth-device');
                                devices.forEach(d => d.classList.remove('active'));
                                this.classList.add('active');
                            });
                        }
                    }
                    
                    showLoading(false);
                    showStatus('Bluetooth device found: ' + (device.name || 'Unknown Device'), 'success');
                } catch (error) {
                    console.error('Error scanning Bluetooth devices:', error);
                    
                    if (bluetoothList) {
                        bluetoothList.innerHTML = `
                            <div class="collection-item red lighten-5">
                                <div class="red-text">Error: ${error.message}</div>
                            </div>
                        `;
                    }
                    
                    showStatus('Error scanning Bluetooth devices: ' + error.message, 'error');
                    showLoading(false);
                }
            }
            
            // Scan for USB devices
            async function scanUsbDevices() {
                try {
                    showLoading(true);
                    
                    const usbList = document.getElementById('usbDevices');
                    if (usbList) {
                        usbList.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';
                    }
                    
                    // Check USB support
                    if (!('usb' in navigator)) {
                        throw new Error('USB API not supported in this browser');
                    }
                    
                    // Request device
                    const device = await navigator.usb.requestDevice({
                        filters: [
                            // Common printer vendor IDs
                            { vendorId: 0x04b8 }, // Epson
                            { vendorId: 0x0519 }, // Star
                            { vendorId: 0x07CF }, // Casio
                            { vendorId: 0x0DD4 }  // Custom printers
                        ]
                    });
                    
                    console.log('USB device selected:', device);
                    
                    // Display device in the list
                    if (usbList) {
                        usbList.innerHTML = `
                            <a href="#!" class="collection-item usb-device" data-id="${device.serialNumber}" data-vendor="${device.vendorId}" data-product="${device.productId}">
                                <div>${device.productName || 'USB Device'} (${device.vendorId.toString(16)}:${device.productId.toString(16)})</div>
                                <span class="secondary-content green-text">
                                    <i class="material-icons">check</i>
                                </span>
                            </a>
                        `;
                        
                        // Add click event to select device
                        const deviceElement = usbList.querySelector('.usb-device');
                        if (deviceElement) {
                            deviceElement.addEventListener('click', function() {
                                // Select this device
                                const devices = usbList.querySelectorAll('.usb-device');
                                devices.forEach(d => d.classList.remove('active'));
                                this.classList.add('active');
                            });
                        }
                    }
                    
                    showLoading(false);
                    showStatus('USB device found: ' + (device.productName || 'Unknown Device'), 'success');
                } catch (error) {
                    console.error('Error scanning USB devices:', error);
                    
                    if (usbList) {
                        usbList.innerHTML = `
                            <div class="collection-item red lighten-5">
                                <div class="red-text">Error: ${error.message}</div>
                            </div>
                        `;
                    }
                    
                    showStatus('Error scanning USB devices: ' + error.message, 'error');
                    showLoading(false);
                }
            }
            
            // Test network printer connection
            function testNetworkConnection() {
                try {
                    const ipAddress = document.getElementById('networkIp').value;
                    const port = document.getElementById('networkPort').value;
                    
                    if (!ipAddress) {
                        throw new Error('Please enter an IP address');
                    }
                    
                    // Validate IP address format
                    const ipPattern = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
                    if (!ipPattern.test(ipAddress)) {
                        throw new Error('Invalid IP address format');
                    }
                    
                    // Simulate testing network connection
                    showLoading(true);
                    
                    // In a real implementation, this would make an actual connection test
                    setTimeout(() => {
                        showLoading(false);
                        showStatus(`Successfully connected to ${ipAddress}:${port}`, 'success');
                    }, 1500);
                } catch (error) {
                    console.error('Error testing network connection:', error);
                    showStatus('Error testing network connection: ' + error.message, 'error');
                }
            }
            
            // Save printer configuration
            async function savePrinter() {
                try {
                    // Get form values
                    const printerName = document.getElementById('printerName').value;
                    const printerDepartment = document.getElementById('printerDepartment').value;
                    
                    if (!printerName) {
                        throw new Error('Please enter a printer name');
                    }
                    
                    if (!printerDepartment) {
                        throw new Error('Please select a department');
                    }
                    
                    // Determine which tab is active
                    const activeTab = tabs ? tabs.index : 0;
                    let printerType, printerData;
                    
                    switch (activeTab) {
                        case 0: // Bluetooth
                            printerType = 'BLUETOOTH';
                            const bluetoothDevice = document.querySelector('.bluetooth-device.active');
                            if (!bluetoothDevice) {
                                throw new Error('Please select a Bluetooth device');
                            }
                            printerData = {
                                id: bluetoothDevice.dataset.id,
                                name: bluetoothDevice.dataset.name
                            };
                            break;
                            
                        case 1: // Network
                            printerType = 'NETWORK';
                            const ipAddress = document.getElementById('networkIp').value;
                            const port = document.getElementById('networkPort').value;
                            
                            if (!ipAddress) {
                                throw new Error('Please enter an IP address');
                            }
                            
                            printerData = {
                                ip: ipAddress,
                                port: port || '9100'
                            };
                            break;
                            
                        case 2: // USB
                            printerType = 'USB';
                            const usbDevice = document.querySelector('.usb-device.active');
                            if (!usbDevice) {
                                throw new Error('Please select a USB device');
                            }
                            printerData = {
                                id: usbDevice.dataset.id,
                                vendorId: usbDevice.dataset.vendor,
                                productId: usbDevice.dataset.product
                            };
                            break;
                            
                        default:
                            throw new Error('Invalid printer type');
                    }
                    
                    // Create printer object
                    const printer = {
                        id: 'printer_' + Date.now(),
                        name: printerName,
                        department: printerDepartment,
                        type: printerType,
                        data: printerData
                    };
                    
                    showLoading(true);
                    
                    // Save printer to service
                    const result = await window.printerService.addPrinter(printer);
                    
                    if (result.success) {
                        // Close modal
                        if (modalInstance) {
                            modalInstance.close();
                        }
                        
                        // Reload printers
                        await loadPrinters();
                        
                        // Show success message
                        showStatus('Printer added successfully', 'success');
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                    
                    showLoading(false);
                } catch (error) {
                    console.error('Error saving printer:', error);
                    showStatus('Error saving printer: ' + error.message, 'error');
                    showLoading(false);
                }
            }
            
            // Test print function
            function testPrint() {
                try {
                    showStatus('Sending test print...', 'info');
                    
                    // Get the first available printer
                    window.printerService.getPrinters().then(printers => {
                        if (printers.length === 0) {
                            throw new Error('No printers available. Please add a printer first.');
                        }
                        
                        // Get the first printer
                        const printer = printers[0];
                        
                        // Send test print
                        window.printerService.print(printer.id, {
                            type: 'RECEIPT',
                            data: {
                                title: 'TEST RECEIPT',
                                content: 'This is a test receipt from FoodBao',
                                items: [
                                    { name: 'Test Item 1', price: 10.00 },
                                    { name: 'Test Item 2', price: 15.50 }
                                ],
                                total: 25.50
                            }
                        }).then(result => {
                            if (result.success) {
                                showStatus('Test print sent successfully', 'success');
                            } else {
                                throw new Error(result.error || 'Unknown error');
                            }
                        }).catch(error => {
                            throw error;
                        });
                    }).catch(error => {
                        throw error;
                    });
                } catch (error) {
                    console.error('Error sending test print:', error);
                    showStatus('Error sending test print: ' + error.message, 'error');
                }
            }
            
            // Fetch profile data
            async function fetchProfileData() {
                try {
                    // Implementation for fetching profile data
                    console.log('Fetching profile data...');
                } catch (error) {
                    console.error('Error fetching profile data:', error);
                }
            }
            
            // Show status message
            function showStatus(message, type = 'info') {
                if (!statusMessage) return;
                
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';
                
                // Hide after 5 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Show or hide loading overlay
            function showLoading(show) {
                if (!loadingOverlay) return;
                
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
        });
    </script>
</body>
</html>
                
                // Initialize Modal
                if (document.getElementById('addPrinterModal')) {
                    modalInstance = M.Modal.init(document.getElementById('addPrinterModal'), {
                        dismissible: false,
                        opacity: 0.5
                    });
                }
                
                // Initialize Tabs
                if (document.querySelector('.tabs')) {
                    tabs = M.Tabs.init(document.querySelector('.tabs'), {});
                }
                
                // Initialize Selects
                selects = document.querySelectorAll('select');
                if (selects.length > 0) {
                    M.FormSelect.init(selects);
                }
                
                setupEventListeners();
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Update receipt date
                const now = new Date();
                const receiptDateEl = document.getElementById('receiptDate');
                if (receiptDateEl) {
                    receiptDateEl.textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                }
                
                if (addPrinterBtn) {
                    addPrinterBtn.addEventListener('click', () => {
                        resetPrinterForm();
                        if (modalInstance) modalInstance.open();
                    });
                }
                
                if (savePrinterBtn) {
                    savePrinterBtn.addEventListener('click', savePrinter);
                }
                
                if (scanBluetoothBtn) {
                    scanBluetoothBtn.addEventListener('click', scanForBluetoothDevices);
                }
                
                if (scanUsbBtn) {
                    scanUsbBtn.addEventListener('click', scanForUsbDevices);
                }
                
                if (testNetworkBtn) {
                    testNetworkBtn.addEventListener('click', testNetworkConnection);
                }
                
                // Test print button
                const testPrintBtn = document.getElementById('testPrintBtn');
                if (testPrintBtn) {
                    testPrintBtn.addEventListener('click', testPrint);
                }
                
                // Department filter event listeners
                if (departmentFilter) {
                    departmentFilter.querySelectorAll('.department-chip').forEach(chip => {
                        chip.addEventListener('click', function() {
                            // Remove active class from all chips
                            departmentFilter.querySelectorAll('.department-chip').forEach(c => {
                                c.classList.remove('active');
                            });
                            
                            // Add active class to clicked chip
                            this.classList.add('active');
                            
                            // Filter printers
                            const department = this.dataset.department;
                            filterPrintersByDepartment(department);
                        });
                    });
                }
                
                // Auto-print toggle
                if (autoPrintCheckbox) {
                    autoPrintCheckbox.addEventListener('change', function() {
                        localStorage.setItem('autoPrint', this.checked);
                    });
                }
            }
            
            // Fetch profile data from API
            async function fetchProfileData() {
                // Implementation depends on your API
                console.log('Fetching profile data...');
            }
            
            // Check if needed APIs are supported
            function checkApiSupport() {
                const supportInfo = {
                    bluetooth: 'bluetooth' in navigator,
                    usb: 'usb' in navigator,
                    network: true // Network printing via API is always available
                };
                
                // Update UI for unsupported features
                if (!supportInfo.bluetooth) {
                    const bluetoothTab = document.querySelector('#bluetoothTab');
                    if (bluetoothTab) {
                        bluetoothTab.innerHTML = 
                            '<p class="red-text">Your browser does not support Bluetooth. Please use Chrome, Edge, or Opera.</p>';
                    }
                    
                    const bluetoothTabLink = document.querySelector('#bluetoothTabLink');
                    if (bluetoothTabLink) {
                        bluetoothTabLink.classList.add('disabled');
                    }
                }
                
                if (!supportInfo.usb) {
                    const usbTab = document.querySelector('#usbTab');
                    if (usbTab) {
                        usbTab.innerHTML = 
                            '<p class="red-text">Your browser does not support USB devices or you\'re not using the installed PWA.</p>';
                    }
                    
                    const usbTabLink = document.querySelector('#usbTabLink');
                    if (usbTabLink) {
                        usbTabLink.classList.add('disabled');
                    }
                }
                
                return supportInfo;
            }
            
            // Initialize printer manager
            async function initPrinterManager() {
                try {
                    // Check API support
                    const apiSupport = checkApiSupport();
                    console.log('API support:', apiSupport);
                    
                    // Load printers from database
                    await loadPrinters();
                    
                    // Initialize event handlers
                    if (typeof initEventHandlers === 'function') {
                        initEventHandlers();
                    }
                } catch (error) {
                    console.error('Error initializing printer manager:', error);
                    showStatus('Error initializing printer manager: ' + error.message, 'error');
                }
            }
            
            // Show loading overlay
            function showLoading(message = 'Processing...') {
                if (!loadingOverlay) {
                    loadingOverlay = document.getElementById('loadingOverlay');
                    if (!loadingOverlay) {
                        console.error('Loading overlay element not found');
                        return;
                    }
                }
                const messageEl = document.querySelector('.loading-message');
                if (messageEl) {
                    messageEl.textContent = message;
                }
                loadingOverlay.classList.add('active');
            }
            
            // Hide loading overlay
            function hideLoading() {
                if (!loadingOverlay) {
                    loadingOverlay = document.getElementById('loadingOverlay');
                    if (!loadingOverlay) {
                        console.error('Loading overlay element not found');
                        return;
                    }
                }
                loadingOverlay.classList.remove('active');
            }
            
            // Show status message
            function showStatus(message, type = 'info') {
                if (!statusMessage) {
                    statusMessage = document.getElementById('statusMessage');
                    if (!statusMessage) {
                        console.error('Status message element not found');
                        return;
                    }
                }
                
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';
                
                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Load printers from database
            async function loadPrinters() {
                try {
                    showLoading('Loading printers...');
                    
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        throw new Error('Authentication required');
                    }
                    
                    // Get client ID from localStorage
                    const clientId = localStorage.getItem('client_id');
                    
                    // API call to get printers
                    const response = await fetch('../api/printers', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error loading printers: ${response.status}`);
                    }
                    
                    const printerData = await response.json();
                    
                    // Render printers
                    renderPrinters(printerData.data || []);
                    
                } catch (error) {
                    console.error('Error loading printers:', error);
                    if (typeof showStatus === 'function') {
                        showStatus(`Error: ${error.message}`, 'error');
                    }
                    
                    // Show empty state
                    if (printerList) {
                        printerList.innerHTML = `
                            <div class="printer-item" style="text-align: center; color: #888;">
                                No printers configured or error loading printers. Click "Add New Printer" to set up a printer.
                            </div>
                        `;
                    }
                } finally {
                    hideLoading();
                }
            }
            
            // Render printers in the list
            function renderPrinters(printers) {
                if (!printerList) {
                    printerList = document.getElementById('printerList');
                    if (!printerList) {
                        console.error('Printer list element not found');
                        return;
                    }
                }
                
                if (!printers || printers.length === 0) {
                    printerList.innerHTML = `
                        <div class="printer-item" style="text-align: center; color: #888;">
                            No printers configured. Click "Add New Printer" to set up a printer.
                        </div>
                    `;
                    return;
                }
                
                printerList.innerHTML = '';
                
                printers.forEach(printer => {
                    const printerItem = document.createElement('div');
                    printerItem.className = `printer-item ${printer.department || ''}`;
                    printerItem.dataset.id = printer.id;
                    printerItem.dataset.department = printer.department;
                    
                    let printerTypeIcon = 'print';
                    let connectionDetails = '';
                    
                    switch (printer.printer_type) {
                        case 'BLUETOOTH':
                            printerTypeIcon = 'bluetooth';
                            connectionDetails = `Bluetooth: ${printer.device_name || 'Unknown Device'}`;
                            break;
                        case 'USB':
                            printerTypeIcon = 'usb';
                            connectionDetails = `USB: ${printer.device_name || 'Unknown Device'}`;
                            break;
                        case 'NETWORK':
                            printerTypeIcon = 'wifi';
                            connectionDetails = `IP: ${printer.ip_address}:${printer.port || 9100}`;
                            break;
                        default:
                            connectionDetails = 'Unknown connection type';
                    }
                    
                    const defaultBadge = printer.is_default ? 
                        `<span class="badge" style="background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">Default</span>` : '';
                    
                    printerItem.innerHTML = `
                        <div class="printer-header">
                            <div class="printer-name">
                                ${printer.name} ${defaultBadge}
                            </div>
                            <div class="printer-actions">
                                <button class="btn-custom btn-small edit-printer-btn" data-id="${printer.id}">
                                    <i class="material-icons" style="font-size: 14px;">edit</i>
                                </button>
                                <button class="btn-custom btn-small test-printer-btn" data-id="${printer.id}">
                                    <i class="material-icons" style="font-size: 14px;">print</i>
                                </button>
                                <button class="btn-custom btn-small delete-printer-btn" style="background-color: var(--danger-color);" data-id="${printer.id}">
                                    <i class="material-icons" style="font-size: 14px;">delete</i>
                                </button>
                            </div>
                        </div>
                        <div class="printer-details">
                            <div class="printer-detail">
                                <i class="material-icons">${printerTypeIcon}</i>
                                <span>${connectionDetails}</span>
                            </div>
                            <div class="printer-detail">
                                <i class="material-icons">category</i>
                                <span>${(printer.department || 'General').charAt(0).toUpperCase() + (printer.department || 'General').slice(1)}</span>
                            </div>
                        </div>
                    `;
                    
                    // Add event listeners for buttons
                    printerItem.querySelector('.edit-printer-btn').addEventListener('click', () => editPrinter(printer.id));
                    printerItem.querySelector('.test-printer-btn').addEventListener('click', () => testPrinterById(printer.id));
                    printerItem.querySelector('.delete-printer-btn').addEventListener('click', () => deletePrinter(printer.id));
                    
                    printerList.appendChild(printerItem);
                });
            }
            
            // Filter printers by department
            function filterPrintersByDepartment(department) {
                const printerItems = document.querySelectorAll('.printer-item');
                
                printerItems.forEach(item => {
                    if (department === 'all' || item.dataset.department === department) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            // Reset printer form when adding new printer
            function resetPrinterForm() {
                const printerIdEl = document.getElementById('printerId');
                const printerNameEl = document.getElementById('printerName');
                const printerDeptEl = document.getElementById('printerDepartment');
                const networkIpEl = document.getElementById('networkIp');
                const networkPortEl = document.getElementById('networkPort');
                const isDefaultEl = document.getElementById('isDefaultPrinter');
                
                if (printerIdEl) printerIdEl.value = '';
                if (printerNameEl) printerNameEl.value = '';
                if (printerDeptEl) printerDeptEl.value = 'kitchen';
                if (networkIpEl) networkIpEl.value = '';
                if (networkPortEl) networkPortEl.value = '9100';
                if (isDefaultEl) isDefaultEl.checked = false;
                
                // Reset select dropdowns
                const bluetoothDevices = document.getElementById('bluetoothDevices');
                if (bluetoothDevices) {
                    bluetoothDevices.innerHTML = '<option value="" disabled selected>Select a device</option>';
                }
                
                const usbDevices = document.getElementById('usbDevices');
                if (usbDevices) {
                    usbDevices.innerHTML = '<option value="" disabled selected>Select a device</option>';
                }
                
                // Reinitialize select dropdowns
                if (typeof M !== 'undefined') {
                    M.FormSelect.init(document.querySelectorAll('select'));
                }
                
                // Set active tab to Network (most common)
                if (tabs) {
                    tabs.select('networkTab');
                }
            }
            
            // Scan for Bluetooth devices
            async function scanForBluetoothDevices() {
                try {
                    showLoading('Scanning for Bluetooth devices...');
                    
                    if (!navigator.bluetooth) {
                        throw new Error('Bluetooth not supported in this browser');
                    }
                    
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true
                    });
                    
                    // Clear existing options
                    const select = document.getElementById('bluetoothDevices');
                    if (select) {
                        select.innerHTML = '<option value="" disabled>Select a device</option>';
                        
                        // Add the new device
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.name || 'Unknown Device';
                        option.selected = true;
                        select.appendChild(option);
                        
                        // Reinitialize select dropdown
                        if (typeof M !== 'undefined') {
                            M.FormSelect.init(select);
                        }
                    }
                    
                    showStatus(`Found Bluetooth device: ${device.name || 'Unknown Device'}`, 'success');
                } catch (error) {
                    console.error('Error scanning for Bluetooth devices:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Scan for USB devices
            async function scanForUsbDevices() {
                try {
                    showLoading('Scanning for USB devices...');
                    
                    if (!navigator.usb) {
                        throw new Error('WebUSB not supported in this browser');
                    }
                    
                    const device = await navigator.usb.requestDevice({
                        filters: []  // Empty filters to accept any device
                    });
                    
                    // Clear existing options
                    const select = document.getElementById('usbDevices');
                    if (select) {
                        select.innerHTML = '<option value="" disabled>Select a device</option>';
                        
                        // Add the new device
                        const option = document.createElement('option');
                        option.value = device.serialNumber || device.productId;
                        option.textContent = device.productName || `Device ${device.productId}`;
                        option.selected = true;
                        select.appendChild(option);
                        
                        // Reinitialize select dropdown
                        if (typeof M !== 'undefined') {
                            M.FormSelect.init(select);
                        }
                    }
                    
                    showStatus(`Found USB device: ${device.productName || 'Unknown Device'}`, 'success');
                } catch (error) {
                    console.error('Error scanning for USB devices:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Test network connection
            async function testNetworkConnection() {
                try {
                    showLoading('Testing network connection...');
                    
                    const ipEl = document.getElementById('networkIp');
                    const portEl = document.getElementById('networkPort');
                    
                    if (!ipEl || !ipEl.value) {
                        throw new Error('IP address is required');
                    }
                    
                    const ip = ipEl.value;
                    const port = portEl ? portEl.value : '9100';
                    
                    // Here you would implement a test to see if the printer is reachable
                    // This might need to be done through your API since browsers can't directly connect to TCP ports
                    
                    // Example API call to test printer connection
                    const token = localStorage.getItem('auth_token');
                    const response = await fetch('../api/printers/test-connection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            ip_address: ip,
                            port: port || 9100
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Connection successful!', 'success');
                    } else {
                        throw new Error(result.message || 'Failed to connect to printer');
                    }
                } catch (error) {
                    console.error('Error testing network connection:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Save printer
            async function savePrinter() {
                try {
                    showLoading('Saving printer...');
                    
                    const printerIdEl = document.getElementById('printerId');
                    const printerNameEl = document.getElementById('printerName');
                    const printerDeptEl = document.getElementById('printerDepartment');
                    const isDefaultEl = document.getElementById('isDefaultPrinter');
                    
                    if (!printerNameEl || !printerNameEl.value) {
                        throw new Error('Printer name is required');
                    }
                    
                    const printerId = printerIdEl ? printerIdEl.value : '';
                    const printerName = printerNameEl.value;
                    const printerDepartment = printerDeptEl ? printerDeptEl.value : 'kitchen';
                    const isDefault = isDefaultEl ? isDefaultEl.checked : false;
                    
                    let printerData = {
                        name: printerName,
                        department: printerDepartment,
                        is_default: isDefault
                    };
                    
                    // Get active tab
                    const activeTabEl = document.querySelector('.tabs .active');
                    if (!activeTabEl) {
                        throw new Error('No active tab found');
                    }
                    
                    const activeTab = activeTabEl.getAttribute('href');
                    
                    // Handle different printer types based on tab
                    if (activeTab === '#networkTab') {
                        const ipEl = document.getElementById('networkIp');
                        const portEl = document.getElementById('networkPort');
                        
                        if (!ipEl || !ipEl.value) {
                            throw new Error('IP address is required for network printers');
                        }
                        
                        printerData.printer_type = 'NETWORK';
                        printerData.ip_address = ipEl.value;
                        printerData.port = portEl ? portEl.value : '9100';
                    } else if (activeTab === '#bluetoothTab') {
                        const bluetoothSelect = document.getElementById('bluetoothDevices');
                        if (!bluetoothSelect || !bluetoothSelect.value) {
                            throw new Error('Please select a Bluetooth device');
                        }
                        
                        const deviceId = bluetoothSelect.value;
                        const deviceName = bluetoothSelect.options[bluetoothSelect.selectedIndex].text;
                        
                        printerData.printer_type = 'BLUETOOTH';
                        printerData.device_id = deviceId;
                        printerData.device_name = deviceName;
                    } else if (activeTab === '#usbTab') {
                        const usbSelect = document.getElementById('usbDevices');
                        if (!usbSelect || !usbSelect.value) {
                            throw new Error('Please select a USB device');
                        }
                        
                        const deviceId = usbSelect.value;
                        const deviceName = usbSelect.options[usbSelect.selectedIndex].text;
                        
                        printerData.printer_type = 'USB';
                        printerData.device_id = deviceId;
                        printerData.device_name = deviceName;
                    }
                    
                    // Add client ID
                    const clientId = localStorage.getItem('client_id');
                    if (clientId) {
                        printerData.client_id = clientId;
                    }
                    
                    // API call to save printer
                    const token = localStorage.getItem('auth_token');
                    
                    const url = printerId ? 
                        `../api/printers/${printerId}` : 
                        '../api/printers';
                    
                    const method = printerId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(printerData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus(`Printer successfully ${printerId ? 'updated' : 'added'}!`, 'success');
                        
                        // Close modal
                        if (modalInstance) {
                            modalInstance.close();
                        }
                        
                        // Reload printers
                        await loadPrinters();
                    } else {
                        throw new Error(result.message || 'Failed to save printer');
                    }
                } catch (error) {
                    console.error('Error saving printer:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Edit printer
            async function editPrinter(printerId) {
                try {
                    showLoading('Loading printer details...');
                    
                    const token = localStorage.getItem('auth_token');
                    
                    const response = await fetch(`../api/printers/${printerId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success || !result.data) {
                        throw new Error('Failed to load printer details');
                    }
                    
                    const printer = result.data;
                    
                    // Reset form first
                    resetPrinterForm();
                    
                    // Set form values
                    const printerIdEl = document.getElementById('printerId');
                    const printerNameEl = document.getElementById('printerName');
                    const printerDeptEl = document.getElementById('printerDepartment');
                    const isDefaultEl = document.getElementById('isDefaultPrinter');
                    
                    if (printerIdEl) printerIdEl.value = printer.id;
                    if (printerNameEl) printerNameEl.value = printer.name || '';
                    if (printerDeptEl) printerDeptEl.value = printer.department || 'kitchen';
                    if (isDefaultEl) isDefaultEl.checked = printer.is_default || false;
                    
                    // Set specific fields based on printer type
                    if (printer.printer_type === 'NETWORK') {
                        const ipEl = document.getElementById('networkIp');
                        const portEl = document.getElementById('networkPort');
                        
                        if (ipEl) ipEl.value = printer.ip_address || '';
                        if (portEl) portEl.value = printer.port || '9100';
                        
                        // Set active tab to Network
                        if (tabs) {
                            tabs.select('networkTab');
                        }
                    } else if (printer.printer_type === 'BLUETOOTH') {
                        // Add the device to the select
                        const select = document.getElementById('bluetoothDevices');
                        if (select) {
                            select.innerHTML = '<option value="" disabled>Select a device</option>';
                            
                            const option = document.createElement('option');
                            option.value = printer.device_id;
                            option.textContent = printer.device_name || 'Unknown Device';
                            option.selected = true;
                            select.appendChild(option);
                            
                            // Reinitialize select dropdown
                            if (typeof M !== 'undefined') {
                                M.FormSelect.init(select);
                            }
                        }
                        
                        // Set active tab to Bluetooth
                        if (tabs) {
                            tabs.select('bluetoothTab');
                        }
                    } else if (printer.printer_type === 'USB') {
                        // Add the device to the select
                        const select = document.getElementById('usbDevices');
                        if (select) {
                            select.innerHTML = '<option value="" disabled>Select a device</option>';
                            
                            const option = document.createElement('option');
                            option.value = printer.device_id;
                            option.textContent = printer.device_name || 'Unknown Device';
                            option.selected = true;
                            select.appendChild(option);
                            
                            // Reinitialize select dropdown
                            if (typeof M !== 'undefined') {
                                M.FormSelect.init(select);
                            }
                        }
                        
                        // Set active tab to USB
                        if (tabs) {
                            tabs.select('usbTab');
                        }
                    }
                    
                    // Update select dropdowns
                    if (typeof M !== 'undefined') {
                        M.FormSelect.init(document.querySelectorAll('select'));
                    }
                    
                    // Open modal
                    if (modalInstance) {
                        modalInstance.open();
                    }
                } catch (error) {
                    console.error('Error loading printer details:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Delete printer
            async function deletePrinter(printerId) {
                if (!confirm('Are you sure you want to delete this printer?')) {
                    return;
                }
                
                try {
                    showLoading('Deleting printer...');
                    
                    const token = localStorage.getItem('auth_token');
                    
                    const response = await fetch(`../api/printers/${printerId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Printer successfully deleted!', 'success');
                        
                        // Reload printers
                        await loadPrinters();
                    } else {
                        throw new Error(result.message || 'Failed to delete printer');
                    }
                } catch (error) {
                    console.error('Error deleting printer:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Test print for a specific printer
            async function testPrinterById(printerId) {
                try {
                    showLoading('Sending test print...');
                    
                    const token = localStorage.getItem('auth_token');
                    
                    const response = await fetch(`../api/printers/${printerId}/test-print`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Test print sent successfully!', 'success');
                    } else {
                        throw new Error(result.message || 'Failed to send test print');
                    }
                } catch (error) {
                    console.error('Error sending test print:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Test print button (uses default printer)
            async function testPrint() {
                try {
                    showLoading('Sending test print to default printer...');
                    
                    const token = localStorage.getItem('auth_token');
                    
                    const response = await fetch('../api/printers/default/test-print', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('Test print sent successfully!', 'success');
                    } else {
                        throw new Error(result.message || 'Failed to send test print');
                    }
                } catch (error) {
                    console.error('Error sending test print:', error);
                    showStatus(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            }
        });
    </script>
</body>
</html>